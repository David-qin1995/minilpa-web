# MiniLPA Web å®å¡”éƒ¨ç½²å®Œæ•´æŒ‡å—

## ä¸€ã€æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡

### 1.1 ç³»ç»Ÿè¦æ±‚
- æ“ä½œç³»ç»Ÿï¼šCentOS 7
- å®å¡”é¢æ¿ï¼š7.x æˆ–æ›´é«˜ç‰ˆæœ¬
- å†…å­˜ï¼šè‡³å°‘ 1GB
- ç¡¬ç›˜ï¼šè‡³å°‘ 10GB å¯ç”¨ç©ºé—´

### 1.2 å®‰è£…å®å¡”é¢æ¿

å¦‚æœè¿˜æ²¡æœ‰å®‰è£…å®å¡”é¢æ¿ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
yum install -y wget && wget -O install.sh http://download.bt.cn/install/install_6.0.sh && sh install.sh
```

å®‰è£…å®Œæˆåï¼Œè®°å½•ä¸‹ï¼š
- å®å¡”é¢æ¿åœ°å€
- ç”¨æˆ·å
- å¯†ç 

## äºŒã€å®‰è£… Docker

### 2.1 é€šè¿‡å®å¡”å•†åº—å®‰è£…ï¼ˆæ¨èï¼‰

1. ç™»å½•å®å¡”é¢æ¿
2. ç‚¹å‡»å·¦ä¾§èœå•ã€Œè½¯ä»¶å•†åº—ã€
3. æœç´¢ã€ŒDockerã€
4. ç‚¹å‡»ã€Œå®‰è£…ã€
5. ç­‰å¾…å®‰è£…å®Œæˆ

### 2.2 æ‰‹åŠ¨å®‰è£… Docker

å¦‚æœå®å¡”å•†åº—æ²¡æœ‰ Dockerï¼Œå¯ä»¥æ‰‹åŠ¨å®‰è£…ï¼š

```bash
# å¸è½½æ—§ç‰ˆæœ¬
yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine

# å®‰è£…ä¾èµ–
yum install -y yum-utils device-mapper-persistent-data lvm2

# æ·»åŠ  Docker ä»“åº“
yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

# å®‰è£… Docker
yum install -y docker-ce docker-ce-cli containerd.io

# å¯åŠ¨ Docker
systemctl start docker
systemctl enable docker

# éªŒè¯å®‰è£…
docker --version
```

### 2.3 å®‰è£… Docker Compose

```bash
# ä¸‹è½½ Docker Compose
curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x /usr/local/bin/docker-compose

# éªŒè¯å®‰è£…
docker-compose --version
```

## ä¸‰ã€éƒ¨ç½²åº”ç”¨

### 3.1 ä¸Šä¼ ä»£ç 

#### æ–¹æ³•ä¸€ï¼šä½¿ç”¨å®å¡”æ–‡ä»¶ç®¡ç†å™¨

1. ç™»å½•å®å¡”é¢æ¿
2. ç‚¹å‡»ã€Œæ–‡ä»¶ã€
3. è¿›å…¥ `/www/wwwroot/` ç›®å½•
4. ç‚¹å‡»ã€Œä¸Šä¼ ã€
5. ä¸Šä¼ æ•´ä¸ª `minilpa-web` æ–‡ä»¶å¤¹ï¼ˆå¯ä»¥å…ˆå‹ç¼©æˆ zip æ–‡ä»¶ï¼‰
6. å¦‚æœä¸Šä¼ çš„æ˜¯ zip æ–‡ä»¶ï¼Œå³é”®è§£å‹

#### æ–¹æ³•äºŒï¼šä½¿ç”¨ Gitï¼ˆå¦‚æœä»£ç æ‰˜ç®¡åœ¨ Git ä»“åº“ï¼‰

```bash
cd /www/wwwroot/
git clone https://your-git-repository.git minilpa-web
cd minilpa-web
```

#### æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ SCP/SFTP å·¥å…·

ä½¿ç”¨ FileZillaã€WinSCP ç­‰å·¥å…·ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨ã€‚

### 3.2 è®¾ç½®æƒé™

```bash
cd /www/wwwroot/minilpa-web
chmod -R 755 .
chmod +x deploy.sh
```

### 3.3 è¿è¡Œéƒ¨ç½²è„šæœ¬

```bash
cd /www/wwwroot/minilpa-web
./deploy.sh
```

éƒ¨ç½²è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- æ£€æŸ¥å¹¶å®‰è£… Docker å’Œ Docker Compose
- æ„å»º Docker é•œåƒ
- å¯åŠ¨å®¹å™¨
- æ˜¾ç¤ºéƒ¨ç½²ç»“æœ

ç­‰å¾…å‡ åˆ†é’Ÿï¼Œçœ‹åˆ°ã€Œéƒ¨ç½²æˆåŠŸã€æç¤ºå³å¯ã€‚

### 3.4 éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿è¡Œ
docker ps | grep minilpa-web

# æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://localhost:3001/api/health

# æŸ¥çœ‹æ—¥å¿—
docker logs -f minilpa-web
```

## å››ã€é…ç½® Nginx

### 4.1 æ·»åŠ ç½‘ç«™

1. ç™»å½•å®å¡”é¢æ¿
2. ç‚¹å‡»å·¦ä¾§èœå•ã€Œç½‘ç«™ã€
3. ç‚¹å‡»ã€Œæ·»åŠ ç«™ç‚¹ã€
4. å¡«å†™ä¿¡æ¯ï¼š
   - **åŸŸå**ï¼š`esim.haoyiseo.com`
   - **æ ¹ç›®å½•**ï¼š`/www/wwwroot/minilpa-web`ï¼ˆéšæ„ï¼Œæˆ‘ä»¬ä½¿ç”¨åå‘ä»£ç†ï¼‰
   - **FTP**ï¼šä¸åˆ›å»º
   - **æ•°æ®åº“**ï¼šä¸åˆ›å»º
   - **PHP ç‰ˆæœ¬**ï¼šçº¯é™æ€
5. ç‚¹å‡»ã€Œæäº¤ã€

### 4.2 é…ç½®åå‘ä»£ç†

1. åœ¨ç½‘ç«™åˆ—è¡¨ä¸­æ‰¾åˆ° `esim.haoyiseo.com`
2. ç‚¹å‡»ã€Œè®¾ç½®ã€
3. ç‚¹å‡»ã€Œé…ç½®æ–‡ä»¶ã€
4. å°†ä»¥ä¸‹å†…å®¹æ›¿æ¢åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼š

```nginx
server {
    listen 80;
    server_name esim.haoyiseo.com;

    # è®¿é—®æ—¥å¿—
    access_log /www/wwwlogs/esim.haoyiseo.com.log;
    error_log /www/wwwlogs/esim.haoyiseo.com.error.log;

    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket æ”¯æŒ
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # API ä»£ç†åˆ°åç«¯
    location /api/ {
        proxy_pass http://127.0.0.1:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # è¯·æ±‚ä½“å¤§å°é™åˆ¶
        client_max_body_size 10M;
    }

    # ç¼“å­˜é™æ€èµ„æº
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://127.0.0.1:8080;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # å®‰å…¨å¤´éƒ¨
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Gzip å‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript 
               application/x-javascript application/xml+rss 
               application/json application/javascript;
}
```

5. ç‚¹å‡»ã€Œä¿å­˜ã€
6. ç‚¹å‡»ã€Œé‡è½½é…ç½®ã€

## äº”ã€é…ç½®é˜²ç«å¢™

### 5.1 å®å¡”é¢æ¿é˜²ç«å¢™

1. ç‚¹å‡»å·¦ä¾§èœå•ã€Œå®‰å…¨ã€
2. æ·»åŠ ä»¥ä¸‹ç«¯å£è§„åˆ™ï¼š

| ç«¯å£ | åè®® | è¯´æ˜ |
|------|------|------|
| 80 | TCP | HTTP |
| 443 | TCP | HTTPS |
| 3001 | TCP | åç«¯ API |
| 8080 | TCP | å‰ç«¯é™æ€æ–‡ä»¶ |

### 5.2 æœåŠ¡å™¨é˜²ç«å¢™ï¼ˆCentOS 7ï¼‰

```bash
# æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€
systemctl status firewalld

# å¼€æ”¾ç«¯å£
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --permanent --add-port=443/tcp
firewall-cmd --permanent --add-port=3001/tcp
firewall-cmd --permanent --add-port=8080/tcp

# é‡è½½é˜²ç«å¢™
firewall-cmd --reload

# æŸ¥çœ‹å¼€æ”¾çš„ç«¯å£
firewall-cmd --list-ports
```

### 5.3 äº‘æœåŠ¡å™¨å®‰å…¨ç»„

å¦‚æœä½¿ç”¨é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ç­‰äº‘æœåŠ¡å™¨ï¼Œè¿˜éœ€è¦åœ¨æ§åˆ¶å°é…ç½®å®‰å…¨ç»„è§„åˆ™ï¼Œå¼€æ”¾ç›¸åº”ç«¯å£ã€‚

## å…­ã€é…ç½® SSL è¯ä¹¦ï¼ˆæ¨èï¼‰

### 6.1 ä½¿ç”¨ Let's Encrypt å…è´¹è¯ä¹¦

1. åœ¨ç½‘ç«™åˆ—è¡¨ä¸­æ‰¾åˆ° `esim.haoyiseo.com`
2. ç‚¹å‡»ã€Œè®¾ç½®ã€
3. ç‚¹å‡»ã€ŒSSLã€
4. é€‰æ‹©ã€ŒLet's Encryptã€
5. è¾“å…¥é‚®ç®±åœ°å€
6. å‹¾é€‰åŸŸå
7. ç‚¹å‡»ã€Œç”³è¯·ã€
8. ç­‰å¾…è¯ä¹¦ç”³è¯·å®Œæˆ
9. å¼€å¯ã€Œå¼ºåˆ¶ HTTPSã€

### 6.2 ä½¿ç”¨è‡ªå·±çš„è¯ä¹¦

å¦‚æœæœ‰è´­ä¹°çš„è¯ä¹¦ï¼š
1. ç‚¹å‡»ã€Œå…¶ä»–è¯ä¹¦ã€
2. ç²˜è´´è¯ä¹¦å†…å®¹ï¼ˆ.crt æ–‡ä»¶ï¼‰
3. ç²˜è´´ç§é’¥å†…å®¹ï¼ˆ.key æ–‡ä»¶ï¼‰
4. ç‚¹å‡»ã€Œä¿å­˜ã€
5. å¼€å¯ã€Œå¼ºåˆ¶ HTTPSã€

## ä¸ƒã€DNS é…ç½®

### 7.1 åŸŸåè§£æ

åœ¨åŸŸåæœåŠ¡å•†å¤„æ·»åŠ  A è®°å½•ï¼š

| ä¸»æœºè®°å½• | è®°å½•ç±»å‹ | è®°å½•å€¼ |
|---------|---------|--------|
| esim æˆ– @ | A | æœåŠ¡å™¨å…¬ç½‘ IP |

### 7.2 éªŒè¯è§£æ

```bash
# Linux/Mac
ping esim.haoyiseo.com

# æˆ–ä½¿ç”¨ nslookup
nslookup esim.haoyiseo.com
```

ç­‰å¾… DNS ç”Ÿæ•ˆï¼ˆé€šå¸¸ 10 åˆ†é’Ÿåˆ° 24 å°æ—¶ï¼‰ã€‚

## å…«ã€æµ‹è¯•è®¿é—®

### 8.1 æµè§ˆå™¨è®¿é—®

æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®ï¼š
- HTTP: `http://esim.haoyiseo.com`
- HTTPS: `https://esim.haoyiseo.com`ï¼ˆå¦‚æœé…ç½®äº† SSLï¼‰

### 8.2 API æµ‹è¯•

```bash
# å¥åº·æ£€æŸ¥
curl http://esim.haoyiseo.com/api/health

# è·å–é…ç½®æ–‡ä»¶åˆ—è¡¨
curl http://esim.haoyiseo.com/api/profiles
```

## ä¹ã€æ—¥å¸¸ç»´æŠ¤

### 9.1 æŸ¥çœ‹æ—¥å¿—

```bash
# å®¹å™¨æ—¥å¿—
docker logs -f minilpa-web

# Nginx è®¿é—®æ—¥å¿—
tail -f /www/wwwlogs/esim.haoyiseo.com.log

# Nginx é”™è¯¯æ—¥å¿—
tail -f /www/wwwlogs/esim.haoyiseo.com.error.log
```

### 9.2 é‡å¯æœåŠ¡

```bash
# é‡å¯å®¹å™¨
docker restart minilpa-web

# é‡å¯ Nginxï¼ˆåœ¨å®å¡”é¢æ¿è½¯ä»¶å•†åº—ä¸­ï¼‰
# æˆ–ä½¿ç”¨å‘½ä»¤
systemctl restart nginx
```

### 9.3 æ›´æ–°åº”ç”¨

```bash
cd /www/wwwroot/minilpa-web

# å¦‚æœä½¿ç”¨ Git
git pull

# é‡æ–°éƒ¨ç½²
./deploy.sh
```

### 9.4 å¤‡ä»½æ•°æ®

```bash
# å¤‡ä»½æ•´ä¸ªé¡¹ç›®
cd /www/wwwroot
tar -czf minilpa-web-backup-$(date +%Y%m%d).tar.gz minilpa-web

# æˆ–ä½¿ç”¨å®å¡”é¢æ¿çš„å¤‡ä»½åŠŸèƒ½
# è®¡åˆ’ä»»åŠ¡ -> æ·»åŠ è®¡åˆ’ä»»åŠ¡ -> å¤‡ä»½ç›®å½•
```

### 9.5 ç›‘æ§èµ„æº

```bash
# æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
docker stats minilpa-web

# æŸ¥çœ‹ç³»ç»Ÿèµ„æº
top
htop
```

## åã€å¸¸è§é—®é¢˜æ’æŸ¥

### 10.1 æ— æ³•è®¿é—®ç½‘ç«™

**æ£€æŸ¥æ¸…å•ï¼š**

1. å®¹å™¨æ˜¯å¦è¿è¡Œï¼Ÿ
   ```bash
   docker ps | grep minilpa-web
   ```

2. ç«¯å£æ˜¯å¦å¼€æ”¾ï¼Ÿ
   ```bash
   netstat -tlnp | grep -E '3001|8080'
   ```

3. é˜²ç«å¢™æ˜¯å¦æ”¾è¡Œï¼Ÿ
   ```bash
   firewall-cmd --list-ports
   ```

4. Nginx é…ç½®æ˜¯å¦æ­£ç¡®ï¼Ÿ
   ```bash
   nginx -t
   ```

5. DNS æ˜¯å¦è§£æï¼Ÿ
   ```bash
   ping esim.haoyiseo.com
   ```

### 10.2 API è¯·æ±‚å¤±è´¥

```bash
# æ£€æŸ¥åç«¯æœåŠ¡
curl http://localhost:3001/api/health

# æŸ¥çœ‹åç«¯æ—¥å¿—
docker logs minilpa-web
```

### 10.3 å®¹å™¨å¯åŠ¨å¤±è´¥

```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
docker logs minilpa-web

# åˆ é™¤å®¹å™¨é‡æ–°éƒ¨ç½²
docker stop minilpa-web
docker rm minilpa-web
./deploy.sh
```

### 10.4 ç«¯å£è¢«å ç”¨

```bash
# æŸ¥çœ‹å ç”¨ç«¯å£çš„è¿›ç¨‹
netstat -tlnp | grep -E '3001|8080'

# åœæ­¢å ç”¨ç«¯å£çš„è¿›ç¨‹
kill -9 <PID>
```

### 10.5 å†…å­˜ä¸è¶³

```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h

# æ¸…ç† Docker ç¼“å­˜
docker system prune -a

# é‡å¯æœåŠ¡å™¨
reboot
```

## åä¸€ã€æ€§èƒ½ä¼˜åŒ–

### 11.1 å¼€å¯ Nginx ç¼“å­˜

åœ¨ Nginx é…ç½®ä¸­æ·»åŠ ï¼š

```nginx
# åœ¨ http å—ä¸­
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m;

# åœ¨ location å—ä¸­
proxy_cache my_cache;
proxy_cache_valid 200 10m;
```

### 11.2 è°ƒæ•´ Docker èµ„æºé™åˆ¶

ä¿®æ”¹ `docker-compose.yml`ï¼š

```yaml
services:
  minilpa-web:
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
```

### 11.3 ä½¿ç”¨ CDN

å°†é™æ€èµ„æºï¼ˆJSã€CSSã€å›¾ç‰‡ï¼‰æ‰˜ç®¡åˆ° CDNï¼Œå‡è½»æœåŠ¡å™¨å‹åŠ›ã€‚

## åäºŒã€å®‰å…¨åŠ å›º

### 12.1 ä¿®æ”¹ SSH ç«¯å£

```bash
vi /etc/ssh/sshd_config
# ä¿®æ”¹ Port 22 ä¸ºå…¶ä»–ç«¯å£
systemctl restart sshd
```

### 12.2 ç¦æ­¢ Root ç™»å½•

```bash
vi /etc/ssh/sshd_config
# ä¿®æ”¹ PermitRootLogin yes ä¸º no
systemctl restart sshd
```

### 12.3 å®‰è£…é˜²ç«å¢™

å®å¡”é¢æ¿å·²å†…ç½®é˜²ç«å¢™ï¼Œåœ¨ã€Œå®‰å…¨ã€ä¸­é…ç½®å³å¯ã€‚

### 12.4 å®šæœŸæ›´æ–°ç³»ç»Ÿ

```bash
yum update -y
```

## åä¸‰ã€è”ç³»æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. æŸ¥çœ‹é¡¹ç›®æ–‡æ¡£ï¼š`README.md`
2. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶
3. æœç´¢ç±»ä¼¼é—®é¢˜
4. è”ç³»æŠ€æœ¯æ”¯æŒ

---

**ç¥æ‚¨éƒ¨ç½²é¡ºåˆ©ï¼ğŸ‰**

