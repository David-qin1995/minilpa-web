# MiniLPA Web ç¡¬ä»¶é›†æˆæŒ‡å—

æœ¬æŒ‡å—å¸®åŠ©æ‚¨å°†çœŸå®çš„ eSIM è¯»å¡å™¨é›†æˆåˆ° MiniLPA Web ç³»ç»Ÿä¸­ã€‚

---

## ğŸ“‹ å‰ç½®å‡†å¤‡

### ç¡¬ä»¶è¦æ±‚
- âœ… eSIM/eUICC è¯»å¡å™¨ï¼ˆå·²é‡‡è´­ï¼‰
- âœ… USB æ¥å£æˆ–å†…ç½®è¯»å¡å™¨
- âœ… æœåŠ¡å™¨ USB ç«¯å£

### è½¯ä»¶è¦æ±‚
- âœ… CentOS 7 æœåŠ¡å™¨
- âœ… Root æƒé™

---

## ğŸ“¦ ç¬¬ä¸€æ­¥ï¼šå®‰è£… PCSC æœåŠ¡

### 1.1 å®‰è£… PCSC-Lite

```bash
# æ›´æ–°ç³»ç»Ÿ
yum update -y

# å®‰è£… PCSC-Lite å’Œç›¸å…³é©±åŠ¨
yum install -y pcsc-lite pcsc-lite-libs pcsc-lite-ccid

# å®‰è£… USB å·¥å…·ï¼ˆç”¨äºè°ƒè¯•ï¼‰
yum install -y usbutils
```

### 1.2 å¯åŠ¨ PCSC æœåŠ¡

```bash
# å¯åŠ¨æœåŠ¡
systemctl start pcscd

# è®¾ç½®å¼€æœºè‡ªå¯
systemctl enable pcscd

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
systemctl status pcscd

# åº”è¯¥æ˜¾ç¤ºï¼šActive: active (running)
```

### 1.3 éªŒè¯ PCSC å®‰è£…

```bash
# å®‰è£…æµ‹è¯•å·¥å…·
yum install -y pcsc-tools

# åˆ—å‡ºè¯»å¡å™¨ï¼ˆæ’å…¥è¯»å¡å™¨åæ‰§è¡Œï¼‰
pcsc_scan

# åº”è¯¥èƒ½çœ‹åˆ°è¯»å¡å™¨ä¿¡æ¯
```

---

## ğŸ”§ ç¬¬äºŒæ­¥ï¼šå®‰è£… lpac å·¥å…·

lpac æ˜¯å¼€æºçš„ LPAï¼ˆLocal Profile Assistantï¼‰å·¥å…·ï¼Œç”¨äºç®¡ç† eSIMã€‚

### 2.1 å®‰è£…ç¼–è¯‘ä¾èµ–

```bash
# å®‰è£…ç¼–è¯‘å·¥å…·
yum groupinstall -y "Development Tools"
yum install -y git cmake curl-devel pcsclite-devel
```

### 2.2 ä¸‹è½½å¹¶ç¼–è¯‘ lpac

```bash
# è¿›å…¥ä¸´æ—¶ç›®å½•
cd /tmp

# å…‹éš† lpac ä»“åº“
git clone https://github.com/estkme-group/lpac.git
cd lpac

# ç¼–è¯‘
mkdir build && cd build
cmake ..
make

# å®‰è£…åˆ°ç³»ç»Ÿ
make install

# æˆ–è€…å¤åˆ¶åˆ° /usr/local/bin
cp lpac /usr/local/bin/
chmod +x /usr/local/bin/lpac

# éªŒè¯å®‰è£…
lpac --version
```

### 2.3 ä½¿ç”¨é¢„ç¼–è¯‘ç‰ˆæœ¬ï¼ˆæ¨èï¼Œæ›´å¿«ï¼‰

å¦‚æœç¼–è¯‘é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥ä¸‹è½½é¢„ç¼–è¯‘ç‰ˆæœ¬ï¼š

```bash
# ä¸‹è½½æœ€æ–°ç‰ˆæœ¬ï¼ˆæ ¹æ®å®é™…ç‰ˆæœ¬å·è°ƒæ•´ï¼‰
cd /tmp
wget https://github.com/estkme-group/lpac/releases/download/v2.0.0/lpac-linux-x86_64

# é‡å‘½åå¹¶ç§»åŠ¨
mv lpac-linux-x86_64 /usr/local/bin/lpac
chmod +x /usr/local/bin/lpac

# éªŒè¯
lpac --version
```

### 2.4 æµ‹è¯• lpac

```bash
# æ’å…¥è¯»å¡å™¨å’Œ eSIM å¡åæ‰§è¡Œ
lpac chip info

# åº”è¯¥èƒ½çœ‹åˆ°èŠ¯ç‰‡ä¿¡æ¯ï¼ˆEID ç­‰ï¼‰

# åˆ—å‡ºé…ç½®æ–‡ä»¶
lpac profile list

# åº”è¯¥èƒ½çœ‹åˆ°å·²å®‰è£…çš„ eSIM é…ç½®
```

---

## ğŸ³ ç¬¬ä¸‰æ­¥ï¼šDocker å®¹å™¨è®¿é—®ç¡¬ä»¶

### 3.1 ä¿®æ”¹ Dockerfile

æ·»åŠ  PCSC æ”¯æŒï¼š

```dockerfile
# åœ¨ Dockerfile çš„ç”Ÿäº§ç¯å¢ƒé˜¶æ®µæ·»åŠ 
FROM node:18-alpine

WORKDIR /app

# å®‰è£… PCSC æ”¯æŒ
RUN apk add --no-cache pcsc-lite pcsc-lite-libs

# ... å…¶ä»–é…ç½® ...
```

### 3.2 ä¿®æ”¹ docker-compose.yml

å…è®¸å®¹å™¨è®¿é—® USB è®¾å¤‡ï¼š

```yaml
version: '3.8'

services:
  minilpa-web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: minilpa-web
    restart: unless-stopped
    ports:
      - "3001:3001"
      - "8080:8080"
    # æ·»åŠ è®¾å¤‡è®¿é—®æƒé™
    devices:
      - /dev/bus/usb:/dev/bus/usb
    # æ·»åŠ ç‰¹æƒæ¨¡å¼ï¼ˆå¦‚æœéœ€è¦ï¼‰
    privileged: true
    # æŒ‚è½½ PCSC socket
    volumes:
      - /var/run/pcscd/pcscd.comm:/var/run/pcscd/pcscd.comm
    environment:
      - NODE_ENV=production
      - PORT=3001
    networks:
      - minilpa-network

networks:
  minilpa-network:
    driver: bridge
```

### 3.3 æˆ–è€…ä½¿ç”¨ä¸»æœºç½‘ç»œæ¨¡å¼ï¼ˆæ›´ç®€å•ï¼‰

ä¸ä½¿ç”¨å®¹å™¨ï¼Œç›´æ¥åœ¨ä¸»æœºä¸Šè¿è¡Œï¼š

```bash
# å®‰è£… Node.js 18
curl -fsSL https://rpm.nodesource.com/setup_18.x | bash -
yum install -y nodejs

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /www/wwwroot/minilpa-web

# å®‰è£…ä¾èµ–
npm install

# æ„å»ºå‰ç«¯
npm run build

# å¯åŠ¨åç«¯ï¼ˆä½¿ç”¨ PM2 ç®¡ç†ï¼‰
npm install -g pm2
pm2 start server/index.js --name minilpa-backend
pm2 start server/server-static.js --name minilpa-frontend

# ä¿å­˜ PM2 é…ç½®
pm2 save
pm2 startup
```

---

## ğŸ”Œ ç¬¬å››æ­¥ï¼šé›†æˆ lpac åˆ°ä»£ç 

### 4.1 ä¿®æ”¹ LPA æœåŠ¡

ç¼–è¾‘ `server/services/lpa.js`ï¼Œæ›¿æ¢æ¨¡æ‹Ÿæ•°æ®ï¼š

```javascript
import { spawn } from 'child_process'

export class LPAService {
  constructor() {
    this.lpacPath = '/usr/local/bin/lpac'
  }
  
  /**
   * æ‰§è¡Œ lpac å‘½ä»¤
   */
  async execLpac(args) {
    return new Promise((resolve, reject) => {
      const lpac = spawn(this.lpacPath, args)
      let stdout = ''
      let stderr = ''
      
      lpac.stdout.on('data', (data) => {
        stdout += data.toString()
      })
      
      lpac.stderr.on('data', (data) => {
        stderr += data.toString()
      })
      
      lpac.on('close', (code) => {
        if (code === 0) {
          resolve(stdout)
        } else {
          reject(new Error(`lpac failed: ${stderr}`))
        }
      })
      
      lpac.on('error', (err) => {
        reject(err)
      })
    })
  }
  
  /**
   * è·å–æ‰€æœ‰é…ç½®æ–‡ä»¶
   */
  async getProfiles() {
    try {
      const output = await this.execLpac(['profile', 'list'])
      return this.parseProfiles(output)
    } catch (error) {
      console.error('è·å–é…ç½®æ–‡ä»¶å¤±è´¥:', error)
      throw error
    }
  }
  
  /**
   * è§£æé…ç½®æ–‡ä»¶åˆ—è¡¨
   */
  parseProfiles(output) {
    const profiles = []
    const lines = output.split('\n')
    
    for (const line of lines) {
      // æ ¹æ® lpac çš„è¾“å‡ºæ ¼å¼è§£æ
      // ç¤ºä¾‹æ ¼å¼: ICCID: 8986012..., Name: China Mobile, State: enabled
      if (line.includes('ICCID')) {
        const profile = this.parseProfileLine(line)
        if (profile) profiles.push(profile)
      }
    }
    
    return profiles
  }
  
  parseProfileLine(line) {
    // è§£æå•è¡Œé…ç½®æ–‡ä»¶ä¿¡æ¯
    // æ ¹æ®å®é™…çš„ lpac è¾“å‡ºæ ¼å¼è°ƒæ•´
    const iccidMatch = line.match(/ICCID:\s*(\d+)/)
    const nameMatch = line.match(/Name:\s*(.+?)(?:,|$)/)
    const stateMatch = line.match(/State:\s*(enabled|disabled)/)
    
    if (iccidMatch) {
      return {
        iccid: iccidMatch[1],
        name: nameMatch ? nameMatch[1].trim() : '',
        provider: '',
        state: stateMatch ? stateMatch[1] : 'unknown'
      }
    }
    
    return null
  }
  
  /**
   * ä¸‹è½½é…ç½®æ–‡ä»¶
   */
  async downloadProfile(activationCode) {
    try {
      const output = await this.execLpac([
        'profile', 
        'download', 
        '-a', 
        activationCode
      ])
      
      console.log('ä¸‹è½½æˆåŠŸ:', output)
      
      // é‡æ–°è·å–é…ç½®æ–‡ä»¶åˆ—è¡¨
      const profiles = await this.getProfiles()
      return profiles[profiles.length - 1] // è¿”å›æœ€æ–°çš„é…ç½®
    } catch (error) {
      console.error('ä¸‹è½½é…ç½®æ–‡ä»¶å¤±è´¥:', error)
      throw error
    }
  }
  
  /**
   * å¯ç”¨é…ç½®æ–‡ä»¶
   */
  async enableProfile(iccid) {
    try {
      await this.execLpac(['profile', 'enable', iccid])
      console.log('å¯ç”¨æˆåŠŸ:', iccid)
    } catch (error) {
      console.error('å¯ç”¨é…ç½®æ–‡ä»¶å¤±è´¥:', error)
      throw error
    }
  }
  
  /**
   * ç¦ç”¨é…ç½®æ–‡ä»¶
   */
  async disableProfile(iccid) {
    try {
      await this.execLpac(['profile', 'disable', iccid])
      console.log('ç¦ç”¨æˆåŠŸ:', iccid)
    } catch (error) {
      console.error('ç¦ç”¨é…ç½®æ–‡ä»¶å¤±è´¥:', error)
      throw error
    }
  }
  
  /**
   * åˆ é™¤é…ç½®æ–‡ä»¶
   */
  async deleteProfile(iccid) {
    try {
      await this.execLpac(['profile', 'delete', iccid])
      console.log('åˆ é™¤æˆåŠŸ:', iccid)
    } catch (error) {
      console.error('åˆ é™¤é…ç½®æ–‡ä»¶å¤±è´¥:', error)
      throw error
    }
  }
  
  /**
   * è·å–èŠ¯ç‰‡ä¿¡æ¯
   */
  async getChipInfo() {
    try {
      const output = await this.execLpac(['chip', 'info'])
      return this.parseChipInfo(output)
    } catch (error) {
      console.error('è·å–èŠ¯ç‰‡ä¿¡æ¯å¤±è´¥:', error)
      throw error
    }
  }
  
  parseChipInfo(output) {
    // è§£æèŠ¯ç‰‡ä¿¡æ¯
    const eidMatch = output.match(/EID:\s*(\w+)/)
    
    return {
      eid: eidMatch ? eidMatch[1] : '',
      manufacturer: 'Unknown',
      model: 'Unknown'
    }
  }
  
  /**
   * è·å–é€šçŸ¥åˆ—è¡¨
   */
  async getNotifications() {
    try {
      const output = await this.execLpac(['notification', 'list'])
      return this.parseNotifications(output)
    } catch (error) {
      console.error('è·å–é€šçŸ¥å¤±è´¥:', error)
      return []
    }
  }
  
  parseNotifications(output) {
    // è§£æé€šçŸ¥åˆ—è¡¨
    const notifications = []
    // æ ¹æ®å®é™…è¾“å‡ºæ ¼å¼è§£æ
    return notifications
  }
  
  /**
   * å¤„ç†é€šçŸ¥
   */
  async processNotification(seqNumber, operation) {
    try {
      await this.execLpac(['notification', 'process', String(seqNumber)])
      console.log('é€šçŸ¥å¤„ç†æˆåŠŸ:', seqNumber)
    } catch (error) {
      console.error('å¤„ç†é€šçŸ¥å¤±è´¥:', error)
      throw error
    }
  }
  
  /**
   * ç§»é™¤é€šçŸ¥
   */
  async removeNotification(seqNumber) {
    try {
      await this.execLpac(['notification', 'remove', String(seqNumber)])
      console.log('é€šçŸ¥åˆ é™¤æˆåŠŸ:', seqNumber)
    } catch (error) {
      console.error('åˆ é™¤é€šçŸ¥å¤±è´¥:', error)
      throw error
    }
  }
  
  /**
   * è®¾ç½®æ˜µç§°
   */
  async setNickname(iccid, nickname) {
    try {
      await this.execLpac(['profile', 'nickname', iccid, nickname])
      console.log('æ˜µç§°è®¾ç½®æˆåŠŸ:', iccid, nickname)
    } catch (error) {
      console.error('è®¾ç½®æ˜µç§°å¤±è´¥:', error)
      throw error
    }
  }
}
```

---

## ğŸ§ª ç¬¬äº”æ­¥ï¼šæµ‹è¯•ç¡¬ä»¶é›†æˆ

### 5.1 æµ‹è¯• PCSC æœåŠ¡

```bash
# æ’å…¥è¯»å¡å™¨å’Œ eSIM å¡

# æŸ¥çœ‹ USB è®¾å¤‡
lsusb

# æ‰«æè¯»å¡å™¨
pcsc_scan

# åº”è¯¥çœ‹åˆ°è¯»å¡å™¨å’Œå¡ç‰‡ä¿¡æ¯
```

### 5.2 æµ‹è¯• lpac å‘½ä»¤

```bash
# æŸ¥çœ‹èŠ¯ç‰‡ä¿¡æ¯
lpac chip info

# åˆ—å‡ºé…ç½®æ–‡ä»¶
lpac profile list

# å¦‚æœæœ‰é”™è¯¯ï¼Œæ£€æŸ¥ï¼š
# 1. è¯»å¡å™¨æ˜¯å¦æ­£ç¡®è¿æ¥
# 2. PCSC æœåŠ¡æ˜¯å¦è¿è¡Œ
# 3. lpac æ˜¯å¦æœ‰æ‰§è¡Œæƒé™
```

### 5.3 æµ‹è¯• API

```bash
# å¯åŠ¨æœåŠ¡åæµ‹è¯•

# è·å–èŠ¯ç‰‡ä¿¡æ¯
curl http://localhost:3001/api/chip/info

# è·å–é…ç½®æ–‡ä»¶åˆ—è¡¨
curl http://localhost:3001/api/profiles

# åº”è¯¥è¿”å›çœŸå®çš„ç¡¬ä»¶æ•°æ®
```

---

## ğŸ“ ç¬¬å…­æ­¥ï¼šæ›´æ–°éƒ¨ç½²è„šæœ¬

åˆ›å»º `deploy-hardware.sh`ï¼š

```bash
#!/bin/bash

echo "=========================================="
echo "MiniLPA Web ç¡¬ä»¶ç‰ˆæœ¬éƒ¨ç½²"
echo "=========================================="
echo ""

# 1. æ£€æŸ¥ PCSC æœåŠ¡
echo "1. æ£€æŸ¥ PCSC æœåŠ¡..."
if systemctl is-active --quiet pcscd; then
    echo "âœ… PCSC æœåŠ¡æ­£åœ¨è¿è¡Œ"
else
    echo "âŒ PCSC æœåŠ¡æœªè¿è¡Œï¼Œæ­£åœ¨å¯åŠ¨..."
    systemctl start pcscd
    systemctl enable pcscd
fi
echo ""

# 2. æ£€æŸ¥ lpac
echo "2. æ£€æŸ¥ lpac..."
if command -v lpac &> /dev/null; then
    echo "âœ… lpac å·²å®‰è£…"
    lpac --version
else
    echo "âŒ lpac æœªå®‰è£…ï¼"
    echo "è¯·å…ˆå®‰è£… lpacï¼Œå‚è€ƒï¼šç¡¬ä»¶é›†æˆæŒ‡å—.md"
    exit 1
fi
echo ""

# 3. æ£€æŸ¥è¯»å¡å™¨
echo "3. æ£€æŸ¥è¯»å¡å™¨..."
timeout 5 pcsc_scan -n 2>&1 | grep -q "Reader" && echo "âœ… è¯»å¡å™¨å·²è¿æ¥" || echo "âš ï¸  æœªæ£€æµ‹åˆ°è¯»å¡å™¨"
echo ""

# 4. æµ‹è¯• lpac
echo "4. æµ‹è¯• lpac..."
if lpac chip info &> /dev/null; then
    echo "âœ… lpac å·¥ä½œæ­£å¸¸"
    lpac chip info
else
    echo "âš ï¸  lpac æ— æ³•è¯»å–èŠ¯ç‰‡ï¼Œè¯·æ£€æŸ¥ï¼š"
    echo "  - è¯»å¡å™¨æ˜¯å¦æ’å…¥"
    echo "  - eSIM å¡æ˜¯å¦æ’å…¥"
    echo "  - PCSC æœåŠ¡æ˜¯å¦æ­£å¸¸"
fi
echo ""

# 5. éƒ¨ç½²åº”ç”¨ï¼ˆä½¿ç”¨ PM2ï¼Œä¸ä½¿ç”¨ Dockerï¼‰
echo "5. éƒ¨ç½²åº”ç”¨..."

cd /www/wwwroot/minilpa-web

# å®‰è£…ä¾èµ–
npm install

# æ„å»ºå‰ç«¯
npm run build

# å®‰è£… PM2
npm install -g pm2

# åœæ­¢æ—§è¿›ç¨‹
pm2 stop minilpa-backend 2>/dev/null || true
pm2 stop minilpa-frontend 2>/dev/null || true
pm2 delete minilpa-backend 2>/dev/null || true
pm2 delete minilpa-frontend 2>/dev/null || true

# å¯åŠ¨æ–°è¿›ç¨‹
pm2 start server/index.js --name minilpa-backend
pm2 start server/server-static.js --name minilpa-frontend

# ä¿å­˜é…ç½®
pm2 save
pm2 startup

echo "âœ… åº”ç”¨å·²å¯åŠ¨"
echo ""

# 6. éªŒè¯
echo "6. éªŒè¯æœåŠ¡..."
sleep 3

curl -s http://localhost:3001/api/health | grep -q "ok" && echo "âœ… åç«¯æ­£å¸¸" || echo "âŒ åç«¯å¼‚å¸¸"
curl -s -o /dev/null -w "%{http_code}" http://localhost:8080 | grep -q "200" && echo "âœ… å‰ç«¯æ­£å¸¸" || echo "âŒ å‰ç«¯å¼‚å¸¸"

echo ""
echo "=========================================="
echo "éƒ¨ç½²å®Œæˆï¼"
echo "=========================================="
echo ""
echo "å¸¸ç”¨å‘½ä»¤ï¼š"
echo "  pm2 list                 # æŸ¥çœ‹è¿›ç¨‹"
echo "  pm2 logs minilpa-backend # æŸ¥çœ‹åç«¯æ—¥å¿—"
echo "  pm2 restart all          # é‡å¯æ‰€æœ‰æœåŠ¡"
echo "  lpac profile list        # æ‰‹åŠ¨æµ‹è¯• lpac"
echo ""
echo "=========================================="
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: pcsc_scan æ‰¾ä¸åˆ°è¯»å¡å™¨

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥ USB è®¾å¤‡
lsusb

# é‡å¯ PCSC æœåŠ¡
systemctl restart pcscd

# æŸ¥çœ‹æ—¥å¿—
journalctl -u pcscd -f

# ç¡®ä¿è¯»å¡å™¨é©±åŠ¨å·²å®‰è£…
yum install -y pcsc-lite-ccid
```

### é—®é¢˜ 2: lpac æŠ¥é”™ "No reader found"

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥ PCSC æœåŠ¡
systemctl status pcscd

# æµ‹è¯•è¯»å¡å™¨
pcsc_scan

# ç¡®ä¿è¯»å¡å™¨å’Œå¡ç‰‡éƒ½å·²æ’å…¥
```

### é—®é¢˜ 3: Docker å®¹å™¨æ— æ³•è®¿é—®è¯»å¡å™¨

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# ä¸ä½¿ç”¨ Dockerï¼Œæ”¹ç”¨ PM2 ç›´æ¥è¿è¡Œ
# å‚è€ƒä¸Šé¢çš„ deploy-hardware.sh
```

### é—®é¢˜ 4: æƒé™é—®é¢˜

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# å°†ç”¨æˆ·æ·»åŠ åˆ° pcscd ç»„
usermod -a -G pcscd $USER

# æˆ–è€…ä»¥ root è¿è¡Œ
sudo lpac chip info
```

---

## ğŸ“š å‚è€ƒèµ„æº

- **lpac é¡¹ç›®**: https://github.com/estkme-group/lpac
- **PCSC-Lite æ–‡æ¡£**: https://pcsclite.apdu.fr/
- **eSIM è§„èŒƒ**: https://www.gsma.com/esim/

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š
1. æŸ¥çœ‹ lpac æ—¥å¿—
2. æŸ¥çœ‹ PCSC æ—¥å¿—ï¼š`journalctl -u pcscd`
3. æµ‹è¯•ç¡¬ä»¶è¿æ¥
4. è”ç³»æŠ€æœ¯æ”¯æŒ

---

**ç¥æ‚¨ç¡¬ä»¶é›†æˆé¡ºåˆ©ï¼** ğŸ‰

