# 测试 IP 统计功能

## 🎯 测试目的

验证在线人数统计是否按照 IP 地址正确计数。

---

## ✅ 测试场景

### 场景 1：同一台电脑，多个浏览器标签页

**预期结果：** 在线人数显示 **1** 人（同一 IP）

**测试步骤：**
1. 打开第 1 个标签页访问 http://localhost:3000
2. 查看在线人数：应该显示 `1 在线`
3. 打开第 2 个标签页访问 http://localhost:3000
4. 查看在线人数：仍然显示 `1 在线`
5. 打开第 3 个标签页
6. 在线人数依然是 `1 在线`

**原因：** 所有标签页来自同一个 IP 地址

---

### 场景 2：不同电脑/网络

**预期结果：** 每个不同 IP 算 1 人

**测试步骤：**
1. 电脑 A（IP: 192.168.1.100）访问 → `1 在线`
2. 电脑 B（IP: 192.168.1.101）访问 → `2 在线`
3. 电脑 C（IP: 192.168.1.102）访问 → `3 在线`
4. 电脑 A 关闭所有标签页 → `2 在线`
5. 电脑 B 关闭所有标签页 → `1 在线`

---

### 场景 3：通过 Nginx 代理（生产环境）

**预期结果：** 正确获取真实 IP

**验证步骤：**
1. 访问：http://esim.haoyiseo.com
2. 后端日志应该显示：
   ```
   用户连接 [IP: 客户端真实IP] [Socket: xxx]
   ```
   而不是：
   ```
   用户连接 [IP: 127.0.0.1] [Socket: xxx]
   ```

---

## 🔍 本地测试

### 1. 启动服务器

```bash
# 终端 1 - 后端
npm run server

# 终端 2 - 前端
npm run dev
```

### 2. 打开多个标签页

访问：http://localhost:3000

**应该看到：**
- 第 1 个标签页：`1 在线`
- 第 2 个标签页：`1 在线`（不是 2！）
- 第 3 个标签页：`1 在线`（不是 3！）

### 3. 查看后端日志

后端终端应该显示：

```
用户连接 [IP: ::1] [Socket: abc123]
当前在线人数: 1 (按 IP 统计)

用户连接 [IP: ::1] [Socket: def456]
当前在线人数: 1 (按 IP 统计)

用户连接 [IP: ::1] [Socket: ghi789]
当前在线人数: 1 (按 IP 统计)
```

**注意：** `::1` 是 IPv6 的 localhost

---

## 🌐 生产环境测试

### 部署后验证

1. 访问：http://esim.haoyiseo.com
2. 打开浏览器控制台（F12）查看：
   ```
   WebSocket 已连接
   在线人数更新: 1 (按 IP 统计)
   ```

3. 查看服务器日志：
   ```bash
   docker logs -f minilpa-web
   ```
   
   应该看到：
   ```
   用户连接 [IP: 真实公网IP] [Socket: xxx]
   当前在线人数: 1 (按 IP 统计)
   ```

### 多人测试

**邀请朋友测试：**
1. 自己访问 → `1 在线`
2. 朋友 A 访问（不同 IP）→ `2 在线`
3. 朋友 B 访问（不同 IP）→ `3 在线`
4. 朋友 A 关闭 → `2 在线`

---

## 📊 IP 统计逻辑

### 后端实现

```javascript
// 数据结构
const onlineUsers = new Map()
// Map 结构：
// {
//   "192.168.1.100": Set { "socket-id-1", "socket-id-2" },
//   "192.168.1.101": Set { "socket-id-3" },
//   "192.168.1.102": Set { "socket-id-4", "socket-id-5", "socket-id-6" }
// }

// 在线人数 = Map.size = 3 人
```

### IP 获取优先级

1. **x-forwarded-for**（Nginx 代理）
   ```
   x-forwarded-for: 客户端真实IP, 代理IP1, 代理IP2
   取第一个：客户端真实IP
   ```

2. **x-real-ip**（简单代理）
   ```
   x-real-ip: 客户端真实IP
   ```

3. **socket.handshake.address**（直接连接）
   ```
   本地开发: ::1 (IPv6) 或 127.0.0.1 (IPv4)
   ```

---

## 🐛 常见问题

### 问题 1：本地测试显示多个人

**现象：** 打开 3 个标签页，显示 `3 在线`

**原因：** 代码未正确实现按 IP 统计

**解决：** 确保使用最新代码（已修复）

---

### 问题 2：生产环境显示所有人来自 127.0.0.1

**现象：** 后端日志显示 `[IP: 127.0.0.1]`

**原因：** Nginx 未正确传递真实 IP

**解决：** 确保 Nginx 配置包含：
```nginx
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
```

---

### 问题 3：用户关闭标签页后人数不减少

**现象：** 用户离开，在线人数仍然不变

**原因：** WebSocket 断开事件未触发

**解决：** 
- 检查网络连接
- 查看后端日志是否有 "用户断开" 消息
- 等待一段时间（WebSocket 超时）

---

## ✅ 验证清单

本地测试：
- [ ] 打开多个标签页，在线人数显示 1
- [ ] 关闭所有标签页，在线人数变为 0
- [ ] 后端日志显示正确的 IP 地址
- [ ] 后端日志显示 "(按 IP 统计)"

生产环境：
- [ ] Nginx 配置包含 IP 传递头
- [ ] WebSocket 路径正确代理
- [ ] 后端日志显示真实公网 IP
- [ ] 多人访问时人数正确增加

---

## 📝 测试报告模板

### 测试环境
- 测试时间：____
- 测试地点：本地 / 生产
- 测试人数：____

### 测试结果

**场景 1（同一 IP）：**
- 打开 1 个标签页：显示 ___ 在线 ✅/❌
- 打开 2 个标签页：显示 ___ 在线 ✅/❌
- 打开 3 个标签页：显示 ___ 在线 ✅/❌

**场景 2（不同 IP）：**
- 设备 A 访问：___ 在线 ✅/❌
- 设备 B 访问：___ 在线 ✅/❌
- 设备 C 访问：___ 在线 ✅/❌

**后端日志：**
```
粘贴后端日志...
```

### 结论
- [ ] 测试通过
- [ ] 测试失败（原因：____）

---

## 🎉 完成标志

**本地测试通过：**
- 多个标签页显示同一在线人数
- 后端日志正确显示 IP
- 用户断开连接人数正确减少

**生产测试通过：**
- 显示真实公网 IP
- 不同用户正确计数
- Nginx 代理工作正常

