name: Build and Deploy

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: ğŸ“ Install dependencies
        run: npm install
      
      - name: ğŸ—ï¸ Build project
        run: npm run build
      
      - name: ğŸ“Š Check build output
        run: |
          echo "Build completed!"
          ls -la dist/
      
      - name: ğŸš€ Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "=========================================="
            echo "å¼€å§‹éƒ¨ç½² MiniLPA Web"
            echo "=========================================="
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /www/wwwroot/minilpa-web || exit 1
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            git pull origin main || git pull origin master
            
            # è¿è¡Œéƒ¨ç½²è„šæœ¬
            chmod +x deploy-docker-light.sh
            ./deploy-docker-light.sh
            
            echo "=========================================="
            echo "éƒ¨ç½²å®Œæˆï¼"
            echo "=========================================="
      
      - name: âœ… Deployment status
        run: |
          echo "ğŸ‰ Deployment successful!"
          echo "Website: http://esim.haoyiseo.com"

